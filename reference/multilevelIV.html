<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Fitting Multilevel GMM Estimation with Endogenous Regressors — multilevelIV • REndo</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Fitting Multilevel GMM Estimation with Endogenous Regressors — multilevelIV" />
<meta property="og:description" content="Estimates multilevel models (max. 3 levels) employing the GMM approach presented in Kim and Frees (2007).
One of the important features is that, using the hierarchical structure of the data, no external instrumental
variables are needed, unlike traditional instrumental variable techniques. Specifically, the approach controls for
endogeneity at higher levels in the data hierarchy. For example, for a three-level model, endogeneity can be handled
either if present at level two, at level three or at both levels. Level one endogeneity, where the regressors are correlated
with the structural errors (errors at level one), is not addressed. Moreover, if considered, random slopes cannot be endogenous.
Also, the dependent variable has to have a continuous distribution.
The function returns the coefficient estimates obtained with fixed effects, random effects and the GMM estimator proposed
by Kim and Frees (2007), such that a comparison across models can be done.
Asymptotically, the multilevel GMM estimators share the same properties of corresponding fixed effects estimators, but they
allow the estimation of all the variables in the model, unlike the fixed effects counterpart.
To facilitate the choice of the estimator to be used for the given data, the function also conducts
omitted variable test based on the Hausman-test for panel data (Hausman, 1978). It allows to compare
a robust estimator and an estimator that is efficient under the null hypothesis of no omitted variables,
and to compare two robust estimators at different levels. The results of these tests are returned when
calling summary() on a fitted model." />






<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-31477052-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-31477052-1');
</script>


  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">REndo</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.4.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/REndo-introduction.html">REndo: A Package to Address Endogeneity Without External Instrumental Variables</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/mmeierer/REndo/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Fitting Multilevel GMM Estimation with Endogenous Regressors</h1>
    <small class="dont-index">Source: <a href='https://github.com/mmeierer/REndo/blob/master/R/f_multilevelIV.R'><code>R/f_multilevelIV.R</code></a></small>
    <div class="hidden name"><code>multilevelIV.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Estimates multilevel models (max. 3 levels) employing the GMM approach presented in Kim and Frees (2007).
One of the important features is that, using the hierarchical structure of the data, no external instrumental
variables are needed, unlike traditional instrumental variable techniques. Specifically, the approach controls for
endogeneity at higher levels in the data hierarchy. For example, for a three-level model, endogeneity can be handled
either if present at level two, at level three or at both levels. Level one endogeneity, where the regressors are correlated
with the structural errors (errors at level one), is not addressed. Moreover, if considered, random slopes cannot be endogenous.
Also, the dependent variable has to have a continuous distribution.
The function returns the coefficient estimates obtained with fixed effects, random effects and the GMM estimator proposed
by Kim and Frees (2007), such that a comparison across models can be done.
Asymptotically, the multilevel GMM estimators share the same properties of corresponding fixed effects estimators, but they
allow the estimation of all the variables in the model, unlike the fixed effects counterpart.</p>
<p>To facilitate the choice of the estimator to be used for the given data, the function also conducts
omitted variable test based on the Hausman-test for panel data (Hausman, 1978). It allows to compare
a robust estimator and an estimator that is efficient under the null hypothesis of no omitted variables,
and to compare two robust estimators at different levels. The results of these tests are returned when
calling <code><a href='summary.rendo.multilevel.html'>summary()</a></code> on a fitted model.</p>
    </div>

    <pre class="usage"><span class='fu'>multilevelIV</span><span class='op'>(</span>
  <span class='va'>formula</span>,
  <span class='va'>data</span>,
  lmer.control <span class='op'>=</span> <span class='fu'>lmerControl</span><span class='op'>(</span>optimizer <span class='op'>=</span> <span class='st'>"Nelder_Mead"</span>, optCtrl <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>maxfun <span class='op'>=</span> <span class='fl'>1e+05</span><span class='op'>)</span><span class='op'>)</span>,
  verbose <span class='op'>=</span> <span class='cn'>TRUE</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>formula</th>
      <td><p>A symbolic description of the model to be fitted. See the "Details" section for the exact notation.</p></td>
    </tr>
    <tr>
      <th>data</th>
      <td><p>A data.frame containing the data of all parts specified in the formula parameter.</p></td>
    </tr>
    <tr>
      <th>lmer.control</th>
      <td><p>An output from <code>lmerControl</code> that will be used to fit the <code>lmer</code> model from which the variance and
correlation are obtained.</p></td>
    </tr>
    <tr>
      <th>verbose</th>
      <td><p>Show details about the running of the function.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p><code>multilevelIV</code> returns an object of class "<code>rendo.multilevel</code>".</p>
<p>The generic accessor functions <code>coef</code>, <code>fitted</code>, <code>residuals</code>, <code>vcov</code>, <code>confint</code>, and <code>nobs</code>, are available.
Note that an additional argument <code>model</code> with possible values <code>"REF", "FE_L2", "FE_L3", "GMM_L2"</code>, or <code>"GMM_L3"</code> is
available for <code><a href='summary.rendo.multilevel.html'>summary</a></code>, <code>fitted</code>, <code>residuals</code>, <code>confint</code>, and <code>vcov</code>
to extract the features for the specified model.</p>
<p>Note that the obtained coefficients are rounded with <code><a href='https://rdrr.io/r/base/Round.html'>round(x, digits=getOption("digits"))</a></code>.</p>

<p>An object of class <code>rendo.multilevel</code> is returned that is a list and contains the following components:</p>
<dt>formula</dt><dd><p>the formula given to specify the model to be fitted.</p></dd>
<dt>num.levels</dt><dd><p>the number of levels detected from the model.</p></dd>
<dt>dt.model.data</dt><dd><p>a data.table of model data including data for slopes and level group ids</p></dd>
<dt>coefficients</dt><dd><p>a matrix of rounded coefficients, one column per model.</p></dd>
<dt>coefficients.se</dt><dd><p>a matrix of coefficients' SE, one column per model.</p></dd>
<dt>l.fitted</dt><dd><p>a named list which contains the fitted values per model sorted as the input data</p></dd>
<dt>l.residuals</dt><dd><p>a named list which contains the residuals per model sorted as the input data</p></dd>
<dt>l.vcov</dt><dd><p>a list of variance-covariance matrix, named per model.</p></dd>
<dt>V</dt><dd><p>the variance–covariance matrix V of the disturbance term.</p></dd>
<dt>W</dt><dd><p>the weight matrix W, such that W=V^(-1/2) per highest level group.</p></dd>
<dt>l.ovt</dt><dd><p>a list of results of the Hausman OVT, named per model.</p></dd>

    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    
<h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Method</h3>
<p>Multilevel modeling is a generalization of regression methods that recognize the existence of such data hierarchies
by allowing for residual components at each level in the hierarchy. For example, a three-level multilevel model which
allows for grouping of students within classrooms, over time, would include time, student and classroom residuals
(see equation below). Thus, the residual variance is partitioned into four components:
between-classroom (the variance of the classroom-level residuals), within-classroom (the variance of the student-level residuals),
between student (the variance of the student-level residuals) and within-student (the variance of the time-level residuals).
The classroom residuals represent the unobserved classroom characteristics that affect student's outcomes.
These unobserved variables lead to correlation between outcomes for students from the same classroom.
Similarly, the unobserved time residuals lead to correlation between a student's outcomes over time.
A three-level model can be described as follows:</p>
<p><center>y<sub>cst</sub> = Z<sup>1</sup><sub>cst</sub> &beta;<sup>1</sup><sub>cs</sub> + X<sup>1</sup><sub>cst</sub> &beta;<sub>1</sub> &epsilon;<sup>1</sup><sub>cst</sub> </center>
<br><center> &beta;<sup>1</sup><sub>cs</sub> =  Z<sup>2</sup><sub>cs</sub> &beta;<sup>2</sup><sub>c</sub> + X <sup>2</sup><sub>cs</sub> &beta;<sub>2</sub> &epsilon;<sup>2</sup><sub>cs</sub> </center>
<br><center> &beta;<sup>2</sup><sub>c</sub> = X<sup>3</sup><sub>c</sub>&beta;<sub>3</sub> &epsilon;<sup>3</sup><sub>c</sub> </center></p>
<p>Like in single-level regression, in multilevel models endogeneity is also a concern. The additional problem is that in multilevel models
there are multiple independent assumptions involving various random components at different levels. Any moderate correlation between some
predictors and a random component or error term, can result in a significant bias of the coefficients and of the variance components.
The multilevel GMM approach for addressing endogeneity uses both the between and within variations of the exogenous variables, but only the within
variation of the variables assumed endogenous. The assumptions in the multilevel generalized moment of moments model is that the errors at each level
are normally distributed and independent of each other. Moreover, the slope variables are assumed exogenous. Since the model does not handle
"level 1 dependencies", an additional assumption is that the level 1 structural error is uncorrelated with any of the regressors.
If this assumption is not met, additional, external instruments are necessary.
The coefficients of the explanatory variables appear in the vectors &beta;<sub>1</sub>,
&beta;<sub>2</sub> and &beta;<sub>3</sub>.
The term &beta;<sup>1</sup><sub>cs</sub> captures latent, unobserved characteristics that are classroom and student specific
while &beta;<sup>2</sup><sub>c</sub> captures latent,
unobserved characteristics that are classroom specific. For identification, the disturbance term
&epsilon;<sub>cst</sub> is assumed independent of
the other variables, Z<sup>1</sup><sub>cst</sub> and X<sup>1</sup><sub>cst</sub>.
When all model variables are assumed exogenous, the GMM estimator is the usual GLS estimator, denoted as REF. When all variables (except the variables used as slope)
are assumed endogenous, the fixed-effects estimator is used, FE. While REF assumes all explanatory variables are uncorrelated with the
random intercepts and slopes in the model, FE allows for endogeneity of all effects but sweeps out the random components as well as the
explanatory variables at the same levels. The more general estimator GMM proposed by Kim and Frees (2007) allows for some of the explanatory
variables to be endogenous and uses this information to build instrumental variables. The multilevel GMM estimator uses both the between and
within variations of the exogenous variables, but only the within variation of the variables assumed endogenous. When all variables are assumed
exogenous, GMM estimator equals REF. When all covariates are assume endogenous, GMM equals FE.</p>

<h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Formula parameter</h3>


<p>The <code>formula</code> argument follows a two part notation:</p>
<p>In the first part, the model is specified while in the second part, the endogenous regressors are indicated.
These two parts are separated by a single vertical bar (<code><a href='https://rdrr.io/r/base/Logic.html'>|</a></code>).</p>
<p>The first RHS follows the exact same model specification as required by the <code><a href='https://rdrr.io/pkg/lme4/man/lmer.html'>lmer</a></code>
function of package <code>lme4</code> and internally will be used to fit a <code>lmer</code> model. In the second part,
one or multiple endogenous regressors are indicated by passing them to the special function <code>endo</code>
(e.g. <code>endo(X1, X2)</code>). Note that no argument to <code>endo()</code> is to be supplied as character
but as symbols without quotation marks.</p>
<p>See the example section for illustrations on how to specify the <code>formula</code> parameter.</p>

    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Hausman J (1978). “Specification Tests in Econometrics.” Econometrica, 46(6), 1251–1271.</p>
<p>Kim, Jee-Seon and Frees, Edward W. (2007). "Multilevel Modeling with Correlated Effects". Psychometrika, 72(4), 505-533.</p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><code><a href='https://rdrr.io/pkg/lme4/man/lmer.html'>lmer</a></code> for more details on how to specify the <code>formula</code> parameter</p>
<p><code><a href='https://rdrr.io/pkg/lme4/man/lmerControl.html'>lmerControl</a></code> for more details on how to provide the <code>lmer.control</code> parameter</p>
<p><code><a href='summary.rendo.multilevel.html'>summary</a></code> for how fitted models are summarized</p></div>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># \donttest{</span>
<span class='fu'><a href='https://rdrr.io/r/utils/data.html'>data</a></span><span class='op'>(</span><span class='st'>"dataMultilevelIV"</span><span class='op'>)</span>

<span class='co'># Two levels</span>
<span class='va'>res.ml.L2</span> <span class='op'>&lt;-</span> <span class='fu'>multilevelIV</span><span class='op'>(</span><span class='va'>y</span> <span class='op'>~</span> <span class='va'>X11</span> <span class='op'>+</span> <span class='va'>X12</span> <span class='op'>+</span> <span class='va'>X13</span> <span class='op'>+</span> <span class='va'>X14</span> <span class='op'>+</span> <span class='va'>X15</span> <span class='op'>+</span> <span class='va'>X21</span> <span class='op'>+</span> <span class='va'>X22</span> <span class='op'>+</span> <span class='va'>X23</span> <span class='op'>+</span> <span class='va'>X24</span> <span class='op'>+</span> <span class='va'>X31</span> <span class='op'>+</span>
                              <span class='va'>X32</span> <span class='op'>+</span> <span class='va'>X33</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>SID</span><span class='op'>)</span> <span class='op'>|</span> <span class='fu'>endo</span><span class='op'>(</span><span class='va'>X15</span><span class='op'>)</span>,
                          data <span class='op'>=</span> <span class='va'>dataMultilevelIV</span>, verbose <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>

<span class='co'># Three levels</span>
<span class='va'>res.ml.L3</span> <span class='op'>&lt;-</span> <span class='fu'>multilevelIV</span><span class='op'>(</span><span class='va'>y</span> <span class='op'>~</span> <span class='va'>X11</span> <span class='op'>+</span> <span class='va'>X12</span> <span class='op'>+</span> <span class='va'>X13</span> <span class='op'>+</span> <span class='va'>X14</span> <span class='op'>+</span> <span class='va'>X15</span> <span class='op'>+</span> <span class='va'>X21</span> <span class='op'>+</span> <span class='va'>X22</span> <span class='op'>+</span> <span class='va'>X23</span> <span class='op'>+</span> <span class='va'>X24</span> <span class='op'>+</span> <span class='va'>X31</span> <span class='op'>+</span>
                              <span class='va'>X32</span> <span class='op'>+</span> <span class='va'>X33</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span> <span class='va'>CID</span><span class='op'>)</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>SID</span><span class='op'>)</span> <span class='op'>|</span> <span class='fu'>endo</span><span class='op'>(</span><span class='va'>X15</span><span class='op'>)</span>,
                          data <span class='op'>=</span> <span class='va'>dataMultilevelIV</span>, verbose <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>


<span class='co'># L2 with multiple endogenous regressors</span>
<span class='va'>res.ml.L2</span> <span class='op'>&lt;-</span> <span class='fu'>multilevelIV</span><span class='op'>(</span><span class='va'>y</span> <span class='op'>~</span> <span class='va'>X11</span> <span class='op'>+</span> <span class='va'>X12</span> <span class='op'>+</span> <span class='va'>X13</span> <span class='op'>+</span> <span class='va'>X14</span> <span class='op'>+</span> <span class='va'>X15</span> <span class='op'>+</span> <span class='va'>X21</span> <span class='op'>+</span> <span class='va'>X22</span> <span class='op'>+</span> <span class='va'>X23</span> <span class='op'>+</span> <span class='va'>X24</span> <span class='op'>+</span> <span class='va'>X31</span> <span class='op'>+</span>
                              <span class='va'>X32</span> <span class='op'>+</span> <span class='va'>X33</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>SID</span><span class='op'>)</span> <span class='op'>|</span> <span class='fu'>endo</span><span class='op'>(</span><span class='va'>X15</span>, <span class='va'>X21</span>, <span class='va'>X22</span><span class='op'>)</span>,
                          data <span class='op'>=</span> <span class='va'>dataMultilevelIV</span>, verbose <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>

<span class='co'># same as above</span>
<span class='va'>res.ml.L2</span> <span class='op'>&lt;-</span> <span class='fu'>multilevelIV</span><span class='op'>(</span><span class='va'>y</span> <span class='op'>~</span> <span class='va'>X11</span> <span class='op'>+</span> <span class='va'>X12</span> <span class='op'>+</span> <span class='va'>X13</span> <span class='op'>+</span> <span class='va'>X14</span> <span class='op'>+</span> <span class='va'>X15</span> <span class='op'>+</span> <span class='va'>X21</span> <span class='op'>+</span> <span class='va'>X22</span> <span class='op'>+</span> <span class='va'>X23</span> <span class='op'>+</span> <span class='va'>X24</span> <span class='op'>+</span> <span class='va'>X31</span> <span class='op'>+</span>
                              <span class='va'>X32</span> <span class='op'>+</span> <span class='va'>X33</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>SID</span><span class='op'>)</span> <span class='op'>|</span> <span class='fu'>endo</span><span class='op'>(</span><span class='va'>X15</span>, <span class='va'>X21</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'>endo</span><span class='op'>(</span><span class='va'>X22</span><span class='op'>)</span>,
                          data <span class='op'>=</span> <span class='va'>dataMultilevelIV</span>, verbose <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>

<span class='co'># Fit above model with different settings for lmer()</span>
<span class='va'>lmer.control</span> <span class='op'>&lt;-</span> <span class='fu'>lme4</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/lme4/man/lmerControl.html'>lmerControl</a></span><span class='op'>(</span>optimizer<span class='op'>=</span><span class='st'>"nloptwrap"</span>,
                                  optCtrl<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>algorithm<span class='op'>=</span><span class='st'>"NLOPT_LN_COBYLA"</span>,
                                               xtol_rel<span class='op'>=</span><span class='fl'>1e-6</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>res.ml.L2.cob</span> <span class='op'>&lt;-</span> <span class='fu'>multilevelIV</span><span class='op'>(</span><span class='va'>y</span> <span class='op'>~</span> <span class='va'>X11</span> <span class='op'>+</span> <span class='va'>X12</span> <span class='op'>+</span> <span class='va'>X13</span> <span class='op'>+</span> <span class='va'>X14</span> <span class='op'>+</span> <span class='va'>X15</span> <span class='op'>+</span> <span class='va'>X21</span> <span class='op'>+</span> <span class='va'>X22</span> <span class='op'>+</span> <span class='va'>X23</span> <span class='op'>+</span> <span class='va'>X24</span> <span class='op'>+</span>
                                  <span class='va'>X31</span> <span class='op'>+</span> <span class='va'>X32</span> <span class='op'>+</span> <span class='va'>X33</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>SID</span><span class='op'>)</span> <span class='op'>|</span> <span class='fu'>endo</span><span class='op'>(</span><span class='va'>X15</span>, <span class='va'>X21</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'>endo</span><span class='op'>(</span><span class='va'>X22</span><span class='op'>)</span>,
                              data <span class='op'>=</span> <span class='va'>dataMultilevelIV</span>, verbose <span class='op'>=</span> <span class='cn'>FALSE</span>,
                              lmer.control <span class='op'>=</span> <span class='va'>lmer.control</span><span class='op'>)</span> <span class='co'># use different controls for lmer</span>


<span class='co'># specify argument "model" in the S3 methods to obtain results for the respective model</span>
<span class='co'># default is "REF" for all methods</span>

<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>res.ml.L3</span><span class='op'>)</span>
</div><div class='output co'>#&gt; 
#&gt; Call:
#&gt; multilevelIV(formula = y ~ X11 + X12 + X13 + X14 + X15 + X21 + 
#&gt;     X22 + X23 + X24 + X31 + X32 + X33 + (1 | CID) + (1 | SID) | 
#&gt;     endo(X15), data = dataMultilevelIV, verbose = FALSE)
#&gt; 
#&gt; Number of levels: 3
#&gt; Number of observations: 2824
#&gt; Number of groups: L2(CID): 1368  L3(SID): 40
#&gt; 
#&gt; Coefficients for model REF:
#&gt;             Estimate Std. Error z-score Pr(&gt;|z|)    
#&gt; (Intercept) 64.31689    7.87332   8.169 3.11e-16 ***
#&gt; X11          3.02134    0.02576 117.306  &lt; 2e-16 ***
#&gt; X12          8.95222    0.02572 348.131  &lt; 2e-16 ***
#&gt; X13         -2.01942    0.02409 -83.835  &lt; 2e-16 ***
#&gt; X14          1.96514    0.02521  77.937  &lt; 2e-16 ***
#&gt; X15         -0.56479    0.01950 -28.962  &lt; 2e-16 ***
#&gt; X21         -2.33162    0.16228 -14.368  &lt; 2e-16 ***
#&gt; X22         -3.95649    0.13119 -30.160  &lt; 2e-16 ***
#&gt; X23         -2.97799    0.06611 -45.044  &lt; 2e-16 ***
#&gt; X24          4.90783    0.19796  24.792  &lt; 2e-16 ***
#&gt; X31          2.11423    0.10433  20.264  &lt; 2e-16 ***
#&gt; X32          0.39348    0.30426   1.293   0.1959    
#&gt; X33          0.10821    0.05236   2.067   0.0388 *  
#&gt; ---
#&gt; Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
#&gt; 
#&gt; Omitted variable tests for model REF:
#&gt;               df     Chisq  p-value    
#&gt; GMM_L2_vs_REF  7     18.74 0.009040 ** 
#&gt; GMM_L3_vs_REF 13 -12872.98 1.000000    
#&gt; FE_L2_vs_REF  13     39.99 0.000139 ***
#&gt; FE_L3_vs_REF  13     39.99 0.000138 ***
#&gt; ---
#&gt; Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</div><div class='input'><span class='co'># same as above</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>res.ml.L3</span>, model <span class='op'>=</span> <span class='st'>"REF"</span><span class='op'>)</span>
</div><div class='output co'>#&gt; 
#&gt; Call:
#&gt; multilevelIV(formula = y ~ X11 + X12 + X13 + X14 + X15 + X21 + 
#&gt;     X22 + X23 + X24 + X31 + X32 + X33 + (1 | CID) + (1 | SID) | 
#&gt;     endo(X15), data = dataMultilevelIV, verbose = FALSE)
#&gt; 
#&gt; Number of levels: 3
#&gt; Number of observations: 2824
#&gt; Number of groups: L2(CID): 1368  L3(SID): 40
#&gt; 
#&gt; Coefficients for model REF:
#&gt;             Estimate Std. Error z-score Pr(&gt;|z|)    
#&gt; (Intercept) 64.31689    7.87332   8.169 3.11e-16 ***
#&gt; X11          3.02134    0.02576 117.306  &lt; 2e-16 ***
#&gt; X12          8.95222    0.02572 348.131  &lt; 2e-16 ***
#&gt; X13         -2.01942    0.02409 -83.835  &lt; 2e-16 ***
#&gt; X14          1.96514    0.02521  77.937  &lt; 2e-16 ***
#&gt; X15         -0.56479    0.01950 -28.962  &lt; 2e-16 ***
#&gt; X21         -2.33162    0.16228 -14.368  &lt; 2e-16 ***
#&gt; X22         -3.95649    0.13119 -30.160  &lt; 2e-16 ***
#&gt; X23         -2.97799    0.06611 -45.044  &lt; 2e-16 ***
#&gt; X24          4.90783    0.19796  24.792  &lt; 2e-16 ***
#&gt; X31          2.11423    0.10433  20.264  &lt; 2e-16 ***
#&gt; X32          0.39348    0.30426   1.293   0.1959    
#&gt; X33          0.10821    0.05236   2.067   0.0388 *  
#&gt; ---
#&gt; Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
#&gt; 
#&gt; Omitted variable tests for model REF:
#&gt;               df     Chisq  p-value    
#&gt; GMM_L2_vs_REF  7     18.74 0.009040 ** 
#&gt; GMM_L3_vs_REF 13 -12872.98 1.000000    
#&gt; FE_L2_vs_REF  13     39.99 0.000139 ***
#&gt; FE_L3_vs_REF  13     39.99 0.000138 ***
#&gt; ---
#&gt; Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</div><div class='input'>
<span class='co'># complete pval table for L3 fixed effects</span>
<span class='va'>L3.FE.p</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/coef.html'>coef</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>res.ml.L3</span>, model <span class='op'>=</span> <span class='st'>"FE_L3"</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># variance covariance matrix</span>
<span class='va'>L2.FE.var</span>  <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/vcov.html'>vcov</a></span><span class='op'>(</span><span class='va'>res.ml.L2</span>, model <span class='op'>=</span> <span class='st'>"FE_L2"</span><span class='op'>)</span>
<span class='va'>L2.GMM.var</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/vcov.html'>vcov</a></span><span class='op'>(</span><span class='va'>res.ml.L2</span>, model <span class='op'>=</span> <span class='st'>"GMM_L2"</span><span class='op'>)</span>
<span class='co'># residuals</span>
<span class='va'>L3.REF.resid</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/residuals.html'>resid</a></span><span class='op'>(</span><span class='va'>res.ml.L3</span>, model <span class='op'>=</span> <span class='st'>"REF"</span><span class='op'>)</span>
<span class='co'># }</span>

</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Raluca Gui, Markus Meierer, Rene Algesheimer, Patrik Schilter.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


